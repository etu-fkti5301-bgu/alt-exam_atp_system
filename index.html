<!DOCTYPE html>

<head>
  <meta charset="utf-8">
  <link rel="stylesheet" type="text/css" href="css/style.css">
  <title>Automated theorem proving system</title>

  <script type="text/javascript">
    const undefinedErrorMessage = 'undefined',
          syntaxErrorMessage = 'Синтаксическая ошибка. Попробуйте снова.',
          emptyFieldMessage = 'Ошибка. Пустое поле для ввода. Заполните и попробуйте снова.';

    const stateComplete = 4, // Request to server completeed and we got some response.
          statusOK = 200; // HTTP status code if everything is OK.

    function printResult(message) {
      document.getElementById('output-content').innerHTML = '<p>' + message + '</p>';
      document.getElementById('output').style.visibility = 'visible';
    }

    /* Unification algorithm has two input arguments. If one checked,
       show second empty input field. User inputs two terms P(...) and P(...). */
    function checkAlgorithm() {
      if (document.getElementById('alg').value == 'unf') {
        document.getElementById('sndInput').value = ''
        document.getElementById('sndInput').hidden = false;
      } else {
        document.getElementById('sndInput').hidden = true;
        document.getElementById('sndInput').value = 'null';
      }
    }

    function sendRequest() {
      if (document.getElementById('fstInput').value == '' ||
          document.getElementById('sndInput').value == '') {
        printResult(emptyFieldMessage);
        return;
      }

      var message = 'alg=' + encodeURIComponent(document.getElementById('alg').value) +
                    '&fstInput=' + encodeURIComponent(document.getElementById('fstInput').value) +
                    '&sndInput=' + encodeURIComponent(document.getElementById('sndInput').value);
                    /* In case of secondInput is empty, server handles it and doesn't care.
                       So we don't care too, send it. */

      var request = new XMLHttpRequest();
      request.open('POST', '/', true);
      request.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      request.onreadystatechange = function() {
        if (request.readyState == stateComplete) {
          if (request.status == statusOK) {
            /* Server sends not rendered special symbols and '\n' in special cases (unf algorithm).
               Remove '\n' and make HTML to render specal symbols. */
            var serverResponse = decodeURIComponent(request.responseText).replace(/\\n/g, '')
                                                                         .replace(/\\/g, "&#");
            switch (serverResponse) {
              case 'undefined':
                printResult(undefinedErrorMessage);
                break;

              case 'stderr':
                printResult(syntaxErrorMessage);
                break;

              default:
                response = JSON.parse(serverResponse);
                printResult('<b>Formula: </b>' + response.parsed[0] + '</br>' +
                            '<b>Result: </b>'+ response.result[0] + '</br>');
                break;
            }
          } else {
            /* In case of server is down. Actually, can't be possible because the page itself
               wouldn't be available. But must be handled.*/
            console.log('error: server: ' + request.status + ': ' + request.statusText);
          }
        }
      }

      request.send(message);
    }
  </script>
</head>

<body>

    <div class="header">
      <h2 class="header-title">
        Automated theorem proving system
      </h2>
    </div> <!-- end header -->

    <div class="help">

      <table border="1">
        <i>Краткая справка по синтаксису. </i>
        <a href="https://docs.google.com/document/d/1Q0X76GlFeh70X-MBp32jdBxOWClvj-1WBueTz3XrGWk/edit?usp=sharing">Подробная справка</a>
        <tr>
          <th>∀ x</th>
          <th>∃ x</th>
          <th>x ∨ y</th>
          <th>x ∧ y</th>
          <th>x ⊃ y</th>
          <th>x ⇔ y</th>
          <th>¬x</th>
          <th>⊤</th>
          <th>⊥</th>
        </tr>
        <tr>
          <td>forall x.</td>
          <td>exists x.</td>
          <td>x \/ y</td>
          <td>x /\ y</td>
          <td>x ==> y</td>
          <td>x <=> y</td>
          <td>~ x</td>
          <td>true</td>
          <td>false</td>
        </tr>
      </table>

      <p>Предикат записывается как P(x, y). Имя переменной и предиката - последовательность</br>
      латинских букв и цифр (не может с них начинаться). Регистр имеет значение. В алгоритмы</br>
      PNF, SNF и Resolution следует подать формулу логики первого порядка. В алгоритм<br/>
      Unification следует подать два терма.</p>

    </div>

    <div class="main">

      <div id="form">
        <input id="fstInput" class="input-field" size="64"/>

        <select id="alg" onchange="checkAlgorithm()">
          <option value="pnf">PNF</option>
          <option value="snf">SNF</option>
          <option value="rsl">Resolution</option>
          <option value="unf">Unification</option>
        </select>

        <button onclick="sendRequest()">Submit</button></br>

        <input id="sndInput" class="input-field" size="64" value="null" hidden="true"/>
      </div>

      <div id="output"> <!-- this div should be made visible after receiving results -->
        <div id="output-content"></div> <!-- put results here -->
      </div>

    </div> <!-- end main -->

    <div class="footer"></div> <!-- end footer -->

</body>
